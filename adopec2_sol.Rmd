---
title: "ADO-PEC2"
author: "Pío Sierra"
date: "31/5/2020"
output: pdf_document
params:
  counts_file: ./counts.csv
  targets_file: ./targets.csv
  samples: 10
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if(!(require(plyr))) 
  install.packages("plyr")
if(!(require(dplyr))) 
  install.packages("dplyr")
if(!(require(ggplot2))) 
  install.packages("ggplot2")
if(!(require(RColorBrewer))) 
  install.packages("RColorBrewer")
if(!(require(DESeq2))) 
  install.packages("DESeq2")
if(!(require(pheatmap))) 
  install.packages("pheatmap")
if(!(require(tibble))) 
  install.packages("tibble")
if(!(require(AnnotationDbi))) 
  BiocManager::install("AnnotationDbi")
if(!(require(org.Hs.eg.db))) 
BiocManager::install("org.Hs.eg.db")

```

***
@github: https://github.com/piosierra/ADO-PEC2

***

# Abstract


# Objetivos

Queremos hacer un análisis de expresión genética diferencial a partir de tres muestras aleatorias de tiroides de `r params$samples` elementos, cada una de tres grupos diferentes:
  - *Not infiltrated tissues* (NIT)
  - *Small focal infiltrates* (SFI)
  - *Extensive lymphoid infiltrates* (ELI)
  
Para ello realizaremos los contrastes:
  - SFI-NIT
  - ELI-NIT
  - ELI_SFI
  
# Materiales y métodos

## Naturaleza de los datos

## Métodos y herramientas
 
## Workflow

# Resultados

# Discusión

# Conclusión

# Apéndice 1




# a) Identify the groups and match groups to files.

```{r}
# Leemos los archivos de datos
targets <- read.csv(params$targets_file)
counts <- read.csv2(params$counts_file, header = TRUE, row.names = 1)

# Comprobamos que no falta ningún dato
sum(is.na(targets))
sum(is.na(counts))

# Observamos la distribución de la media y la desviación estándar de las variables.
plot(apply(counts[-1],2,mean))
plot(apply(counts[-1],2,sd))

# En un archivo se usa "." como separador, y en el otro "-". Los igualamos para poder comparar y asegurarnos de que cruzamos los datos correctamente.
colnames(counts) <-gsub("[.]","-", colnames(counts))

# Comprobamos el número de observaciones que hay de cada grupo.
table(targets$Group)

targets$Group <- as.factor(targets$Group)
  
# Tomamos las muestras de targets.
set.seed(123999)
# Utilizamos la función ddply para obtener el mismo número de muestras de cada grupo del data frame,
# y devolver el resultado en un nuevo dataframe.
targets_sample <- ddply(targets,.(Group),function(x) x[sample(nrow(x),params$samples),])
table(targets_sample$Group)

# Y ahora las muestras correspondientes en counts
counts_sample <- counts[,which(colnames(counts) %in% targets_sample$Sample_Name)]

# Y finalmente las ordenamos de la misma forma según las indicaciones para usar DESeq2. 
targets_sample <- targets_sample[order(targets_sample$Sample_Name),]
counts_sample <- counts_sample[ , order(colnames(counts_sample))]

identical(colnames(counts_sample), targets_sample$Sample_Name)
```
We choose to ignore the `molecular_data_type` information. If we would like to use only RNA Seq data we should filter that field first.


# b) Quality control of the raw data. 

```{r}
# Vemos que la disribución tiene un sesgo muy pronunciado. 
# Mostramos una de las muestras como ejemplo, pero ocurre lo mismo en todas.
qplot(counts_sample[,1], geom="histogram") 
# Log base 2 is typically used as it facilitates the conversion back to the original scale: 
# a difference of 1 on the log base 2 scale corresponds to a fold change of 2 on the original count scale. 
pseudoCount = log2(counts_sample + 1)
qplot(pseudoCount[,1], geom="histogram") 

```

# c) Creating the DESeqDataSet object

We create now the DESeqDataSet object.

```{r include=FALSE}
dds <- DESeqDataSetFromMatrix(countData = counts_sample,
                              colData = targets_sample,
                              design = ~ Group)
```


# d) Exploratory analysis and visualization 

First, for visualization purposes, we will transform the data to make it easier to explore the relationships on it. But for the statistical analysis we will go back to use the full data.

## Pre filtering the data set for empty rows.  
We start by removing all rows which do have one or none count at all.  

```{r include=FALSE}
nrow(dds)
dds <- dds[ rowSums(counts(dds)) > 1, ]
nrow(dds)
```

## Variance stabilizing transformation and rlog

```{r include=FALSE}

vsd <- vst(dds, blind = FALSE)
rld <- rlog(dds, blind = FALSE)

dds <- estimateSizeFactors(dds)

df <- bind_rows(
  as_tibble(log2(counts(dds, normalized=TRUE)[, 1:2]+1)) %>%
         mutate(transformation = "log2(x + 1)"),
  as_tibble(assay(vsd)[, 1:2]) %>% mutate(transformation = "vst"),
  as_tibble(assay(rld)[, 1:2]) %>% mutate(transformation = "rlog"))
  
colnames(df)[1:2] <- c("x", "y")  
png("figures/vst.png", width = 680, height = 680)
print(ggplot(df, aes(x = x, y = y)) + geom_hex(bins = 80) +
  coord_fixed() + facet_grid( . ~ transformation))
dev.off()
```

We can see how genes with low counts (bottom left-hand corner) seem to be excessively variable on the ordinary logarithmic scale, while the VST and rlog compress differences for the low count genes for which the data provide little information about differential expression.  

## Samples distances

```{r include=FALSE}
sampleDists <- dist(t(assay(vsd)))

sampleDistMatrix <- as.matrix( sampleDists )
rownames(sampleDistMatrix) <- paste( vsd$dex, vsd$cell, sep = " - " )
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "BuGn")) )(255)
png("figures/distmatrix.png", width = 680, height = 680)
print(pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         col = colors))
dev.off()
```

## PCA plot

```{r include=FALSE}
plotPCA(vsd, intgroup = c("Group"))
```

# Differential Expression Analysis

```{r include=FALSE}
dds <- DESeq(dds, parallel =TRUE)
resultsNames(dds)
# Group_NIT_vs_ELI
res_NITvELI <- results(dds, contrast=c(0,1,0), alpha = 0.05)
# Group_SFI_vs_ELI
res_SFIvELI <- results(dds, contrast=c(0,0,1), alpha = 0.05)

# Ahora cambiamos el orden de los factores para obtener la comparación que nos falta.

targets_sample$Group <- relevel(targets_sample$Group, "NIT")
dds <- DESeqDataSetFromMatrix(countData = counts_sample,
                              colData = targets_sample,
                              design = ~ Group)
dds <- DESeq(dds, parallel =TRUE)
resultsNames(dds)
# Group_SFI_vs_NIT
res_SFIvNIT <- results(dds, contrast=c(0,0,1), alpha = 0.05)

# Group_ELI_vs_NIT
res_ELIvNIT <- results(dds, contrast=c(0,1,0), alpha = 0.05)
```
## Top genes

```{r include=FALSE}

topGenes_NITvELI <- as.data.frame(res_NITvELI) %>%
    rownames_to_column("GeneID") %>% 
    arrange(padj) %>% 
    head(100)
head(topGenes_NITvELI)
topGenes_SFIvELI <- as.data.frame(res_SFIvELI) %>%
    rownames_to_column("GeneID") %>% 
    arrange(padj) %>% 
    head(100)
head(topGenes_SFIvELI)
topGenes_SFIvNIT <- as.data.frame(res_SFIvNIT) %>%
    rownames_to_column("GeneID") %>% 
    arrange(padj) %>% 
    head(100)
head(topGenes_SFIvNIT)

```

# Annotation

```{r include=FALSE}
columns(org.Hs.eg.db)

res_ELIvNIT$symbol <- mapIds(org.Hs.eg.db,
                      keys=row.names(res_ELIvNIT),
                      column="SYMBOL",
                      keytype="ENSEMBL",
                      multiVals="first")
```


