---
title: "ADO-PEC2"
author: "Pío Sierra"
date: "31/5/2020"
output: pdf_document
params:
  counts_file: ./counts.csv
  targets_file: ./targets.csv
  samples: 10
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if(!(require(plyr))) 
  install.packages("plyr")
if(!(require(dplyr))) 
  install.packages("dplyr")
if(!(require(ggplot2))) 
  install.packages("ggplot2")
if(!(require(RColorBrewer))) 
  install.packages("RColorBrewer")
if(!(require(DESeq2))) 
  install.packages("DESeq2")
if(!(require(pheatmap))) 
  install.packages("pheatmap")

```


# a) Identify the groups and match groups to files.

```{r}
# Leemos los archivos de datos
targets <- read.csv(params$targets_file)
counts <- read.csv2(params$counts_file, header = TRUE, row.names = 1)

# Comprobamos que no falta ningún dato
sum(is.na(targets))
sum(is.na(counts))

# Observamos la distribución de la media y la desviación estándar de las variables.
plot(apply(counts[-1],2,mean))
plot(apply(counts[-1],2,sd))

# En un archivo se usa "." como separador, y en el otro "-". Los igualamos para poder comparar y asegurarnos de que cruzamos los datos correctamente.
colnames(counts) <-gsub("[.]","-", colnames(counts))

# Comprobamos el número de observaciones que hay de cada grupo.
table(targets$Group)

# Tomamos las muestras de targets.
set.seed(123999)
# Utilizamos la función ddply para obtener el mismo número de muestras de cada grupo del data frame,
# y devolver el resultado en un nuevo dataframe.
targets_sample <- ddply(targets,.(Group),function(x) x[sample(nrow(x),params$samples),])
table(targets_sample$Group)

# Y ahora las muestras correspondientes en counts
counts_sample <- counts[,which(colnames(counts) %in% targets_sample$Sample_Name)]
identical(colnames(counts), targets$Sample_Name)
```

# b) Quality control of the raw data. 

```{r}
# Vemos que la disribución tiene un sesgo muy pronunciado. 
# Mostramos una de las muestras como ejemplo, pero ocurre lo mismo en todas.
qplot(counts_sample[,1], geom="histogram") 
# Log base 2 is typically used as it facilitates the conversion back to the original scale: 
# a difference of 1 on the log base 2 scale corresponds to a fold change of 2 on the original count scale. 
pseudoCount = log2(counts_sample + 1)
qplot(pseudoCount[,1], geom="histogram") 

```

# c) Creating the DESeqDataSet object

We create now the DESeqDataSet object.

```{r include=FALSE}
dds <- DESeqDataSetFromMatrix(countData = counts_sample,
                              colData = targets_sample,
                              design = ~ Group)
```


# d) Exploratory analysis and visualization 

First, for visualization purposes, we will transform the data to make it easier to explore the relationships on it. But for the statistical analysis we will go back to use the full data.

## Pre filtering the data set for empty rows.  
We start by removing all rows which do have one or none count at all.  

```{r include=FALSE}
nrow(dds)
dds <- dds[ rowSums(counts(dds)) > 1, ]
nrow(dds)
```

```{r include=FALSE}

vsd <- vst(dds, blind = FALSE)
rld <- rlog(dds, blind = FALSE)

dds <- estimateSizeFactors(dds)

df <- bind_rows(
  as_tibble(log2(counts(dds, normalized=TRUE)[, 1:2]+1)) %>%
         mutate(transformation = "log2(x + 1)"),
  as_tibble(assay(vsd)[, 1:2]) %>% mutate(transformation = "vst"),
  as_tibble(assay(rld)[, 1:2]) %>% mutate(transformation = "rlog"))
  
colnames(df)[1:2] <- c("x", "y")  

ggplot(df, aes(x = x, y = y)) + geom_hex(bins = 80) +
  coord_fixed() + facet_grid( . ~ transformation)  

```

We can see how genes with low counts (bottom left-hand corner) seem to be excessively variable on the ordinary logarithmic scale, while the VST and rlog compress differences for the low count genes for which the data provide little information about differential expression.  

## Samples distances

```{r include=FALSE}
sampleDists <- dist(t(assay(vsd)))

sampleDistMatrix <- as.matrix( sampleDists )
rownames(sampleDistMatrix) <- paste( vsd$dex, vsd$cell, sep = " - " )
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "BuGn")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         col = colors)
```
